<!DOCTYPE html>
<html>
<head>
    <title>Test Thinking Logic</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.8/purify.min.js"></script>
</head>
<body>
    <h1>Test Thinking Logic</h1>
    <div id="chat-history"></div>
    
    <script>
        // Mock state object
        const state = {
            lastThinkingOutput: ''
        };
        
        // Mock handleThinkingModal
        const handleThinkingModal = {
            showThinking: function(state) {
                alert("Showing thinking: " + state.lastThinkingOutput);
            }
        };
        
        // Copy of the updated addMessageToHistory function
        window.addMessageToHistory = (role, content, thinking) => {
            const chatHistory = document.getElementById('chat-history');
            if (!chatHistory) return;
            
            try {
                const suspect = /(?:Ã.|Â.|ð|)/;
                if (typeof content === 'string' && suspect.test(content)) {
                    content = decodeURIComponent(escape(content));
                }
            } catch {}

            const cleanContent = DOMPurify.sanitize(marked.parse(content || ''));

            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', `${role}-message`);
            
            // Check if the content has thinking tags that were processed
            const hasThinkingContent = (thinking && thinking.length > 0) || 
                                      (role === 'assistant' && content && 
                                       (/<(thinking|thought|reasoning|plan|analysis)>/i.test(content) || 
                                        /thinking|reasoning|planning/i.test(content)));
            
            if (hasThinkingContent) {
                // If there's thinking content, store it and add a link to view it
                state.lastThinkingOutput = thinking || content;
                messageDiv.innerHTML = `
                    <span class="message-content">${cleanContent}</span>
                    <div class="thinking-indicator">
                        <a href="#" class="thinking-link" onclick="handleThinkingModal.showThinking(window.state); return false;">View Thinking Process</a>
                    </div>
                `;
            } else {
                // No thinking content, just show the message
                messageDiv.innerHTML = `<span class="message-content">${cleanContent}</span>`;
                if (role === 'assistant') {
                    state.lastThinkingOutput = '';
                }
            }

            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        };
        
        // Test cases
        window.onload = function() {
            // Test 1: Message with thinking content in thinking parameter
            addMessageToHistory('assistant', 'This is a regular response', 'This is the thinking process');
            
            // Test 2: Message with thinking tags in content
            addMessageToHistory('assistant', '<thinking>This is internal thinking</thinking>\nThis is the final response', null);
            
            // Test 3: Regular message without thinking
            addMessageToHistory('assistant', 'This is a regular message with no thinking content', null);
            
            // Test 4: User message (should not show thinking link)
            addMessageToHistory('user', 'User messages should not have thinking links', null);
        };
    </script>
</body>
</html>